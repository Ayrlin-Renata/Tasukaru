/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package com.ayrlin.tasukaru;

import co.casterlabs.caffeinated.pluginsdk.*;
import xyz.e3ndr.fastloggingframework.logging.FastLogger;

@CaffeinatedPluginImplementation
public class Tasukaru extends CaffeinatedPlugin {
    private static Tasukaru instance = null;

    private FastLogger log;
    private TLogic tlogic;
    private TListener tlist;
    private VBHandler vb;

    public Tasukaru() {
        super();
        log = this.getLogger();
        if(instance != null) {
            log.warn("THROWING EXCEPTION FOR DUPLICATE TASUKARU");
            throw new RuntimeException("use Tasukaru.instance(), DO NOT CONSTRUCT THIS A SECOND TIME :3");
        }
        instance = this;
    }

    /**
     * use this singleton dont construct another
     * @return THE ONE TASUKARU
     */
    public static Tasukaru instance() {
        if(instance == null) {
            instance = new Tasukaru();
        }
        return instance;
    }

    @Override
    public void onInit() {
        log.debug("Tasukaru onInit()");
        log.info("Hello World!");

        //TODO settings applet
        //this.createSettingsApplet(); 

        // database init
        vb = VBHandler.instance();
        vb.begin();

        // controller init
        tlogic = TLogic.instance();

        // listener init
        tlist = TListener.instance();
        addKoiListener(tlist);

        // maintenance thread
        
        // AsyncTask.createNonDaemon(() -> {
        //     try {
        //         log.info("DB maintenance thread init");
        //         // TODO implement backups
        //         tlogic.updatePlatforms();
        //         tlogic.fillAccountTableHoles();
        //     } catch(Exception e) {
        //         log.severe("Exception running async thread!\n" + e.getMessage());
        //         log.severe(e.getStackTrace());
        //     } catch(Throwable t) {
        //         log.severe("Throwable thrown running async thread!\n" + t.getMessage());
        //         log.severe(t.getStackTrace());
        //     }
        // });
    }

    @Override
    /**
     * triggers when user unloads the plugin, NOT on application close
     */
    public void onClose() {
        log.debug("Tasukaru onClose()");

        log.info("Tasukaru is leaving bye!");
    }

    @Override
    public String getName() {
        return "Tasukaru";
    }

    @Override
    public String getId() {
        return "com.ayrlin.tasukaru";
    }

}